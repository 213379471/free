name: Tailscale+V2ray

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install Tailscale
        run: |
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/focal.gpg | sudo apt-key add -
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/focal.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt-get update
          sudo apt-get install tailscale

      - name: Start Tailscale
        env:
          TAILSCALE_TOKEN: ${{ secrets.TAILSCALE_TOKEN }}
        run: |
          sudo tailscale login --authkey=$TAILSCALE_TOKEN
          sudo tailscale up
          sudo tailscale set --hostname="github-v2ray-server"

      - name: Start V2ray
        timeout-minutes: 60
        env:
          V2RAY_CONFIG_JSON: ${{ secrets.V2RAY_CONFIG_JSON }}
        run: |
          echo $V2RAY_CONFIG_JSON > v2ray-runtime-config.json
          docker run --network=host --name v2ray -v ${{ github.workspace }}/v2ray-runtime-config.json:/etc/v2fly/config.json -p 10086:10086 v2fly/v2fly-core run -c /etc/v2fly/config.json

      - name: Immediately Cleanup
        if: always()
        run: |
          echo "Immediately Cleanup"
          sudo tailscale logout
